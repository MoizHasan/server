!function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="./js/",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);n(1),n(2),n(3),n(4),n(5);n.nc=btoa(OC.requestToken),n.p=OC.linkTo("files_versions","js/dist/"),window.OCA.Versions=OCA.Versions},function(e,t){var n;n=OC.Backbone.Model.extend({sync:OC.Backbone.davSync,davProperties:{size:"{DAV:}getcontentlength",mimetype:"{DAV:}getcontenttype",timestamp:"{DAV:}getlastmodified"},revert:function(e){e=e?_.clone(e):{};var t=this;return this.get("client").move("/versions/"+this.get("fileId")+"/"+this.get("id"),"/restore/target",!0).done(function(){e.success&&e.success.call(e.context,t,{},e),t.trigger("revert",t,e)}).fail(function(){e.error&&e.error.call(e.context,t,{},e),t.trigger("error",t,{},e)})},getFullPath:function(){return this.get("fullPath")},getPreviewUrl:function(){var e=OC.generateUrl("/apps/files_versions/preview"),t={file:this.get("fullPath"),version:this.get("timestamp")};return e+"?"+OC.buildQueryString(t)},getDownloadUrl:function(){return OC.linkToRemoteBase("dav")+"/versions/"+this.get("user")+"/versions/"+this.get("fileId")+"/"+this.get("id")}}),OCA.Versions=OCA.Versions||{},OCA.Versions.VersionModel=n},function(e,t){var n,i;n=Handlebars.template,(i=OCA.Versions.Templates=OCA.Versions.Templates||{}).item=n({1:function(e,t,n,i,s){var l,o=null!=t?t:e.nullContext||{},r=n.helperMissing,a=e.escapeExpression;return'\t\t\t\t<div class="version-details">\n\t\t\t\t\t<span class="size has-tooltip" title="'+a("function"==typeof(l=null!=(l=n.altSize||(null!=t?t.altSize:t))?l:r)?l.call(o,{name:"altSize",hash:{},data:s}):l)+'">'+a("function"==typeof(l=null!=(l=n.humanReadableSize||(null!=t?t.humanReadableSize:t))?l:r)?l.call(o,{name:"humanReadableSize",hash:{},data:s}):l)+"</span>\n\t\t\t\t</div>\n"},3:function(e,t,n,i,s){var l,o=null!=t?t:e.nullContext||{},r=n.helperMissing,a=e.escapeExpression;return'\t\t\t<a href="#" class="revertVersion" title="'+a("function"==typeof(l=null!=(l=n.revertLabel||(null!=t?t.revertLabel:t))?l:r)?l.call(o,{name:"revertLabel",hash:{},data:s}):l)+'"><img src="'+a("function"==typeof(l=null!=(l=n.revertIconUrl||(null!=t?t.revertIconUrl:t))?l:r)?l.call(o,{name:"revertIconUrl",hash:{},data:s}):l)+'" /></a>\n'},compiler:[7,">= 4.0.0"],main:function(e,t,n,i,s){var l,o,r,a=null!=t?t:e.nullContext||{},c=n.helperMissing,u="function",d=e.escapeExpression,m=n.blockHelperMissing,h='<li data-revision="'+d(typeof(o=null!=(o=n.timestamp||(null!=t?t.timestamp:t))?o:c)===u?o.call(a,{name:"timestamp",hash:{},data:s}):o)+'">\n\t<div>\n\t\t<div class="preview-container">\n\t\t\t<img class="preview" src="'+d(typeof(o=null!=(o=n.previewUrl||(null!=t?t.previewUrl:t))?o:c)===u?o.call(a,{name:"previewUrl",hash:{},data:s}):o)+'" width="44" height="44"/>\n\t\t</div>\n\t\t<div class="version-container">\n\t\t\t<div>\n\t\t\t\t<a href="'+d(typeof(o=null!=(o=n.downloadUrl||(null!=t?t.downloadUrl:t))?o:c)===u?o.call(a,{name:"downloadUrl",hash:{},data:s}):o)+'" class="downloadVersion" download="'+d(typeof(o=null!=(o=n.downloadName||(null!=t?t.downloadName:t))?o:c)===u?o.call(a,{name:"downloadName",hash:{},data:s}):o)+'"><img src="'+d(typeof(o=null!=(o=n.downloadIconUrl||(null!=t?t.downloadIconUrl:t))?o:c)===u?o.call(a,{name:"downloadIconUrl",hash:{},data:s}):o)+'" />\n\t\t\t\t\t<span class="versiondate has-tooltip live-relative-timestamp" data-timestamp="'+d(typeof(o=null!=(o=n.millisecondsTimestamp||(null!=t?t.millisecondsTimestamp:t))?o:c)===u?o.call(a,{name:"millisecondsTimestamp",hash:{},data:s}):o)+'" title="'+d(typeof(o=null!=(o=n.formattedTimestamp||(null!=t?t.formattedTimestamp:t))?o:c)===u?o.call(a,{name:"formattedTimestamp",hash:{},data:s}):o)+'">'+d(typeof(o=null!=(o=n.relativeTimestamp||(null!=t?t.relativeTimestamp:t))?o:c)===u?o.call(a,{name:"relativeTimestamp",hash:{},data:s}):o)+"</span>\n\t\t\t\t</a>\n\t\t\t</div>\n";return o=null!=(o=n.hasDetails||(null!=t?t.hasDetails:t))?o:c,r={name:"hasDetails",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s},l=typeof o===u?o.call(a,r):o,n.hasDetails||(l=m.call(t,l,r)),null!=l&&(h+=l),h+="\t\t</div>\n",o=null!=(o=n.canRevert||(null!=t?t.canRevert:t))?o:c,r={name:"canRevert",hash:{},fn:e.program(3,s,0),inverse:e.noop,data:s},l=typeof o===u?o.call(a,r):o,n.canRevert||(l=m.call(t,l,r)),null!=l&&(h+=l),h+"\t</div>\n</li>\n"},useData:!0}),i.template=n({compiler:[7,">= 4.0.0"],main:function(e,t,n,i,s){var l,o=null!=t?t:e.nullContext||{},r=n.helperMissing,a=e.escapeExpression;return'<ul class="versions"></ul>\n<div class="clear-float"></div>\n<div class="empty hidden">\n\t<div class="emptycontent">\n\t\t<div class="icon-history"></div>\n\t\t<p>'+a("function"==typeof(l=null!=(l=n.emptyResultLabel||(null!=t?t.emptyResultLabel:t))?l:r)?l.call(o,{name:"emptyResultLabel",hash:{},data:s}):l)+'</p>\n\t</div>\n</div>\n<input type="button" class="showMoreVersions hidden" value="'+a("function"==typeof(l=null!=(l=n.moreVersionsLabel||(null!=t?t.moreVersionsLabel:t))?l:r)?l.call(o,{name:"moreVersionsLabel",hash:{},data:s}):l)+'" name="show-more-versions" id="show-more-versions" />\n<div class="loading hidden" style="height: 50px"></div>\n'},useData:!0})},function(e,t){var n;n=OC.Backbone.Collection.extend({model:OCA.Versions.VersionModel,sync:OC.Backbone.davSync,_fileInfo:null,_currentUser:null,_client:null,setFileInfo:function(e){this._fileInfo=e},getFileInfo:function(){return this._fileInfo},setCurrentUser:function(e){this._currentUser=e},getCurrentUser:function(){return this._currentUser||OC.getCurrentUser().uid},setClient:function(e){this._client=e},getClient:function(){return this._client||new OC.Files.Client({host:OC.getHost(),root:OC.linkToRemoteBase("dav")+"/versions/"+this.getCurrentUser(),useHTTPS:"https"===OC.getProtocol()})},url:function(){return OC.linkToRemoteBase("dav")+"/versions/"+this.getCurrentUser()+"/versions/"+this._fileInfo.get("id")},parse:function(e){var t=this._fileInfo.getFullPath(),n=this._fileInfo.get("id"),i=this._fileInfo.get("name"),s=this.getCurrentUser(),l=this.getClient();return _.map(e,function(e){return e.fullPath=t,e.fileId=n,e.name=i,e.timestamp=parseInt(moment(new Date(e.timestamp)).format("X"),10),e.id=parseInt(OC.basename(e.href),10),e.size=parseInt(e.size,10),e.user=s,e.client=l,e})}}),OCA.Versions=OCA.Versions||{},OCA.Versions.VersionCollection=n},function(e,i){var s;s=OCA.Files.DetailTabView.extend({id:"versionsTabView",className:"tab versionsTabView",_template:null,$versionsContainer:null,events:{"click .revertVersion":"_onClickRevertVersion"},initialize:function(){OCA.Files.DetailTabView.prototype.initialize.apply(this,arguments),this.collection=new OCA.Versions.VersionCollection,this.collection.on("request",this._onRequest,this),this.collection.on("sync",this._onEndRequest,this),this.collection.on("update",this._onUpdate,this),this.collection.on("error",this._onError,this),this.collection.on("add",this._onAddModel,this)},getLabel:function(){return t("files_versions","Versions")},getIcon:function(){return"icon-history"},nextPage:function(){this._loading||this.collection.getFileInfo()&&this.collection.getFileInfo().isDirectory()||this.collection.fetch()},_onClickRevertVersion:function(e){var n,i=this,s=$(e.target),l=this.collection.getFileInfo();s.is("li")||(s=s.closest("li")),e.preventDefault(),n=s.attr("data-revision");var o=this.collection.get(n);o.revert({success:function(){i.$versionsContainer.empty(),i.collection.setFileInfo(l),i.collection.reset([],{silent:!0}),i.collection.fetch(),i.$el.find(".versions").removeClass("hidden"),l.trigger("busy",l,!1),l.set({size:o.get("size"),mtime:1e3*o.get("timestamp"),etag:o.get("id")+o.get("timestamp")})},error:function(){l.trigger("busy",l,!1),i.$el.find(".versions").removeClass("hidden"),i._toggleLoading(!1),OC.Notification.show(t("files_version","Failed to revert {file} to revision {timestamp}.",{file:o.getFullPath(),timestamp:OC.Util.formatDate(1e3*o.get("timestamp"))}),{type:"error"})}}),this._toggleLoading(!0),l.trigger("busy",l,!0)},_toggleLoading:function(e){this._loading=e,this.$el.find(".loading").toggleClass("hidden",!e)},_onRequest:function(){this._toggleLoading(!0)},_onEndRequest:function(){this._toggleLoading(!1),this.$el.find(".empty").toggleClass("hidden",!!this.collection.length)},_onAddModel:function(e){var t=$(this.itemTemplate(this._formatItem(e)));this.$versionsContainer.append(t),t.find(".has-tooltip").tooltip()},template:function(e){return OCA.Versions.Templates.template(e)},itemTemplate:function(e){return OCA.Versions.Templates.item(e)},setFileInfo:function(e){e?(this.render(),this.collection.setFileInfo(e),this.collection.reset([],{silent:!0}),this.nextPage()):(this.render(),this.collection.reset())},_formatItem:function(e){var i=1e3*e.get("timestamp"),s=e.has("size")?e.get("size"):0,l=OC.MimeType.getIconUrl(e.get("mimetype")),o=new Image;return o.onload=function(){$("li[data-revision="+e.get("timestamp")+"] .preview").attr("src",e.getPreviewUrl())},o.src=e.getPreviewUrl(),_.extend({versionId:e.get("id"),formattedTimestamp:OC.Util.formatDate(i),relativeTimestamp:OC.Util.relativeModifiedDate(i),millisecondsTimestamp:i,humanReadableSize:OC.Util.humanFileSize(s,!0),altSize:n("files","%n byte","%n bytes",s),hasDetails:e.has("size"),downloadUrl:e.getDownloadUrl(),downloadIconUrl:OC.imagePath("core","actions/download"),downloadName:e.get("name"),revertIconUrl:OC.imagePath("core","actions/history"),previewUrl:l,revertLabel:t("files_versions","Restore"),canRevert:0!=(this.collection.getFileInfo().get("permissions")&OC.PERMISSION_UPDATE)},e.attributes)},render:function(){this.$el.html(this.template({emptyResultLabel:t("files_versions","No other versions available")})),this.$el.find(".has-tooltip").tooltip(),this.$versionsContainer=this.$el.find("ul.versions"),this.delegateEvents()},canDisplay:function(e){return!!e&&!e.isDirectory()}}),OCA.Versions=OCA.Versions||{},OCA.Versions.VersionsTabView=s},function(e,t){OCA.Versions=OCA.Versions||{},OCA.Versions.Util={attach:function(e){"trashbin"!==e.id&&"files.public"!==e.id&&e.registerTabView(new OCA.Versions.VersionsTabView("versionsTabView",{order:-10}))}},OC.Plugins.register("OCA.Files.FileList",OCA.Versions.Util)}]);
//# sourceMappingURL=files_versions.js.map